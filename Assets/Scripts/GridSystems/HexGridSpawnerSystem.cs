using Unity.Burst;‚Ä®using Unity.Collections;‚Ä®using Unity.Entities;‚Ä®using Unity.Mathematics;‚Ä®using Unity.Transforms;‚Ä®using Unity.Rendering;‚Ä®using Unity.Jobs;‚Ä®‚Ä®/// <summary>‚Ä®/// –°–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Hex Grid (Flat-Top, Axial –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã)‚Ä®/// –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º–∞ —Å Quad Grid —Å–∏—Å—Ç–µ–º–æ–π‚Ä®/// </summary>‚Ä®[UpdateInGroup(typeof(InitializationSystemGroup))]‚Ä®public partial struct HexGridSpawnerSystem : ISystem‚Ä®{‚Ä®    [BurstCompile]‚Ä®    public void OnUpdate(ref SystemState state)‚Ä®    {‚Ä®        // üî• –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ GridConfig –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω‚Ä®        var configQuery = SystemAPI.QueryBuilder().WithAll<GridConfig>().Build();‚Ä®        if (!configQuery.IsEmpty) return;‚Ä®    ‚Ä®        // üî• –ò—â–µ–º GridSpawnerComponent —Å Layout == HexFlatTop‚Ä®        var query = SystemAPI.QueryBuilder().WithAll<GridSpawnerComponent>().Build();‚Ä®        if (query.IsEmpty) return;‚Ä®    ‚Ä®        var spawnerEntities = query.ToEntityArray(Allocator.Temp);‚Ä®        var spawnerComponents = query.ToComponentDataArray<GridSpawnerComponent>(Allocator.Temp);‚Ä®    ‚Ä®        if (spawnerEntities.Length > 0)‚Ä®        {‚Ä®            var spawnerEntity = spawnerEntities[0];‚Ä®            var spawnerData = spawnerComponents[0];‚Ä®    ‚Ä®            // üî• –ö–õ–Æ–ß–ï–í–ê–Ø –ü–†–û–í–ï–†–ö–ê: —Ä–∞–±–æ—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ —Å Hex‚Ä®            if (spawnerData.Layout != GridLayoutType.HexFlatTop)‚Ä®            {‚Ä®                spawnerEntities.Dispose();‚Ä®                spawnerComponents.Dispose();‚Ä®                return;‚Ä®            }‚Ä®    ‚Ä®            int qCount = spawnerData.GridSize.x;‚Ä®            int rCount = spawnerData.GridSize.y;‚Ä®            int totalCells = qCount * rCount;‚Ä®    ‚Ä®            // 1. –°–æ–∑–¥–∞–µ–º GridMap (–µ–¥–∏–Ω—ã–π —Å Quad)‚Ä®            var mapEntity = state.EntityManager.CreateEntity();‚Ä®            state.EntityManager.SetName(mapEntity, "GridMap");‚Ä®            state.EntityManager.AddComponentData(mapEntity, new GridMapTag { Size = spawnerData.GridSize });‚Ä®            state.EntityManager.AddBuffer<GridCellElement>(mapEntity);‚Ä®    ‚Ä®            // 2. –°–æ–∑–¥–∞–µ–º GridConfig (–µ–¥–∏–Ω—ã–π —Å Quad)‚Ä®            var configEntity = state.EntityManager.CreateEntity();‚Ä®            state.EntityManager.SetName(configEntity, "GridConfig");‚Ä®            state.EntityManager.AddComponentData(configEntity, new GridConfig‚Ä®            {‚Ä®                GridSize = spawnerData.GridSize,‚Ä®                BrushSize = spawnerData.InitialBrushSize,‚Ä®                Spacing = spawnerData.Spacing,‚Ä®                HeightSky = spawnerData.HeightSky,‚Ä®                HeightGround = spawnerData.HeightGround,‚Ä®                HeightUnderground = spawnerData.HeightUnderground,‚Ä®                FacingMode = spawnerData.FacingMode,‚Ä®                VisualMode = spawnerData.VisualMode,‚Ä®                Layout = GridLayoutType.HexFlatTop // üî• –í–ê–ñ–ù–û‚Ä®            });‚Ä®    ‚Ä®            // 3. –ò–Ω—Å—Ç–∞–Ω—Ü–∏—Ä—É–µ–º hex –ø—Ä–µ—Ñ–∞–±—ã‚Ä®            var instances = new NativeArray<Entity>(totalCells, Allocator.TempJob);‚Ä®            state.EntityManager.Instantiate(spawnerData.PrefabEntity, instances);‚Ä®            state.EntityManager.AddComponent<GridCoordinates>(instances);‚Ä®            state.EntityManager.AddComponent<URPMaterialPropertyBaseColor>(instances);‚Ä®    ‚Ä®            // 4. –ü–æ–ª—É—á–∞–µ–º –±—É—Ñ–µ—Ä –∫–∞—Ä—Ç—ã‚Ä®            var mapBuffer = state.EntityManager.GetBuffer<GridCellElement>(mapEntity);‚Ä®            mapBuffer.ResizeUninitialized(totalCells);‚Ä®    ‚Ä®            // üî• –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Job‚Ä®            // üî• –ß–∏—Ç–∞–µ–º GridColorConfig –î–û —Å–æ–∑–¥–∞–Ω–∏—è Job‚Ä®            var colors = SystemAPI.GetSingleton<GridColorConfig>();‚Ä®    ‚Ä®            var initJob = new InitializeHexGridJob‚Ä®            {‚Ä®                Instances = instances,‚Ä®                GridSize = new int2(qCount, rCount),‚Ä®                HexSize = spawnerData.Spacing,‚Ä®                RandomSeed = 1234,‚Ä®                Transforms = state.GetComponentLookup<LocalTransform>(false),‚Ä®                Coordinates = state.GetComponentLookup<GridCoordinates>(false),‚Ä®                Colors = state.GetComponentLookup<URPMaterialPropertyBaseColor>(false),‚Ä®                MapBuffer = mapBuffer,‚Ä®                ColorGray = colors.ColorGray // üî• –ü–µ—Ä–µ–¥–∞–µ–º —Ü–≤–µ—Ç –≤ Job‚Ä®            };‚Ä®    ‚Ä®    ‚Ä®            var jobHandle = initJob.Schedule(totalCells, 64);‚Ä®            jobHandle.Complete();‚Ä®    ‚Ä®            instances.Dispose();‚Ä®    ‚Ä®            // üî• –£–¥–∞–ª—è–µ–º GridSpawnerComponent, –æ—Å—Ç–∞–≤–ª—è–µ–º GridColorConfig –∫–∞–∫ —Å–∏–Ω–≥–ª—Ç–æ–Ω‚Ä®            state.EntityManager.RemoveComponent<GridSpawnerComponent>(spawnerEntity);‚Ä®            state.EntityManager.SetName(spawnerEntity, "GridColorConfig");‚Ä®        }‚Ä®    ‚Ä®        spawnerEntities.Dispose();‚Ä®        spawnerComponents.Dispose();‚Ä®    }‚Ä®    ‚Ä®    /// <summary>‚Ä®    /// Burst-–∫–æ–º–ø–∏–ª–∏—Ä—É–µ–º–∞—è Job –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Hex Grid‚Ä®    /// </summary>‚Ä®    [BurstCompile]‚Ä®    private struct InitializeHexGridJob : IJobParallelFor‚Ä®    {‚Ä®        [ReadOnly] public NativeArray<Entity> Instances;‚Ä®        [ReadOnly] public int2 GridSize;‚Ä®        [ReadOnly] public float HexSize;‚Ä®        [ReadOnly] public uint RandomSeed;‚Ä®    ‚Ä®        [NativeDisableParallelForRestriction] public ComponentLookup<LocalTransform> Transforms;‚Ä®        [NativeDisableParallelForRestriction] public ComponentLookup<GridCoordinates> Coordinates;‚Ä®        [NativeDisableParallelForRestriction] public ComponentLookup<URPMaterialPropertyBaseColor> Colors;‚Ä®        [NativeDisableParallelForRestriction] public DynamicBuffer<GridCellElement> MapBuffer;‚Ä®        [ReadOnly] public float4 ColorGray; // üî• –¶–≤–µ—Ç –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞‚Ä®    ‚Ä®        public void Execute(int index)‚Ä®        {‚Ä®            // –í—ã—á–∏—Å–ª—è–µ–º Axial –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (q, r) –¥–ª—è –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏‚Ä®            int x = index % GridSize.x;   // –∫–æ–ª–æ–Ω–∫–∞ (X ‚Üí –ø—Ä–∞–≤–æ)‚Ä®            int z = index / GridSize.x;   // —Å—Ç—Ä–æ–∫–∞ (Z ‚Üí –≤–≤–µ—Ä—Ö)‚Ä®‚Ä®            // odd-q offset ‚Üí axial (FlatTop)‚Ä®            int q = x;‚Ä®            int r = z - (x >> 1);‚Ä®‚Ä®            var instance = Instances[index];‚Ä®    ‚Ä®            // –ü–æ–∑–∏—Ü–∏—è —á–µ—Ä–µ–∑ HexGridUtils‚Ä®            float3 pos = HexGridUtils.HexAxialToWorld(new int2(q, r), HexSize);‚Ä®            Transforms[instance] = LocalTransform.FromPositionRotation(pos, quaternion.identity);‚Ä®    ‚Ä®            // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (Axial)‚Ä®            Coordinates[instance] = new GridCoordinates { Value = new int2(q, r) };‚Ä®    ‚Ä®            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π (–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–Ω–¥–æ–º)‚Ä®            var random = Unity.Mathematics.Random.CreateFromIndex((uint)index + RandomSeed);‚Ä®            bool isWall = random.NextFloat() < 0.1f;‚Ä®    ‚Ä®            // –¶–≤–µ—Ç (—Å–µ—Ä—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ GridColorConfig –≤ runtime)‚Ä®            float4 grayColor = new float4(0.5f, 0.5f, 0.5f, 0f);‚Ä®            // –¶–≤–µ—Ç –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ (–Ω–µ —Ö–∞—Ä–¥–∫–æ–¥)‚Ä®            Colors[instance] = new URPMaterialPropertyBaseColor { Value = ColorGray };‚Ä®    ‚Ä®    ‚Ä®            // –ó–∞–ø–æ–ª–Ω—è–µ–º –±—É—Ñ–µ—Ä –∫–∞—Ä—Ç—ã‚Ä®            MapBuffer[index] = new GridCellElement‚Ä®            {‚Ä®                CellEntity = instance,‚Ä®                IsOccupiedGround = isWall,‚Ä®                IsOccupiedUnderground = isWall,‚Ä®                IsOccupiedSky = false,‚Ä®                OccupantGround = Entity.Null,‚Ä®                OccupantUnderground = Entity.Null,‚Ä®                OccupantSky = Entity.Null,‚Ä®                IsHighlighted = false‚Ä®            };‚Ä®        }‚Ä®    }‚Ä®}